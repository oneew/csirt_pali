<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create User - CSIRT PALI Admin</title>
    <link rel="stylesheet" href="frontend/css/user.css">
    <link rel="stylesheet" href="frontend/css/admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="frontend/images/Logo.png" alt="CSIRT PALI">
                    <span>CSIRT PALI</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item">
                        <a href="/admin/dashboard" class="nav-link active">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <div class="nav-item">
                        <a href="/admin/incidents" class="nav-link">
                            <i class="nav-icon fas fa-exclamation-triangle"></i>
                            Incidents
                                <span class="badge"></span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/admin/news" class="nav-link">
                            <i class="nav-icon fas fa-newspaper"></i>
                            News & Updates
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/admin/users" class="nav-link">
                            <i class="nav-icon fas fa-users"></i>
                            Users
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <div class="nav-item">
                        <a href="/admin/reports" class="nav-link">
                            <i class="nav-icon fas fa-chart-bar"></i>
                            Analytics
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/admin/reports/security" class="nav-link">
                            <i class="nav-icon fas fa-shield-alt"></i>
                            Security Logs
                        </a>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <div class="nav-item">
                        <a href="/admin/settings" class="nav-link">
                            <i class="nav-icon fas fa-cog"></i>
                            Settings
                        </a>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <div class="nav-item">
                        <a href="/my-profile" class="nav-link">
                            <i class="nav-icon fas fa-user"></i>
                            Profile
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/logout" class="nav-link" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                            <i class="nav-icon fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>

                <div class="header-right">
                    <div class="search-box">
                        <i class="search-icon fas fa-search"></i>
                        <input type="text" class="search-input" placeholder="Search...">
                    </div>

                    <div class="notifications">
                        <button class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot"></span>
                        </button>
                    </div>

                    <div class="user-menu">
                        <button class="user-btn">
                            <div class="user-avatar">
                            </div>
                            <span></span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
            </header>

          <!-- Page Content -->
            <div class="page-content">
                <div class="form-container">
                    <div class="form-header">
                        <div class="form-title">
                            <i class="fas fa-user-plus"></i>
                            <h1>Create New User</h1>
                        </div>
                        <div class="form-actions">
                            <a href="/admin/users" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i>
                                Back to Users
                            </a>
                        </div>
                    </div>

                    <!-- Multi-step Form -->
                    <div class="form-steps">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-title">Basic Info</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-title">Account Settings</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-title">Permissions</div>
                        </div>
                    </div>

                    <form class="form-card" id="userForm">
                        <!-- Step 1: Basic Information -->
                        <div class="form-step" id="step1">
                            <div class="form-section">
                                <h3 class="section-title">Personal Information</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="first_name" class="form-label required">First Name</label>
                                        <input type="text" id="first_name" name="first_name" class="form-input" required>
                                        <span class="form-error" id="first_name-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="last_name" class="form-label required">Last Name</label>
                                        <input type="text" id="last_name" name="last_name" class="form-input" required>
                                        <span class="form-error" id="last_name-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="email" class="form-label required">Email Address</label>
                                        <input type="email" id="email" name="email" class="form-input" required>
                                        <span class="form-error" id="email-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input type="tel" id="phone" name="phone" class="form-input" placeholder="+62 xxx xxxx xxxx">
                                    </div>

                                    <div class="form-group">
                                        <label for="department" class="form-label">Department</label>
                                        <select id="department" name="department" class="form-select">
                                            <option value="">Select department</option>
                                            <option value="csirt">CSIRT Team</option>
                                            <option value="it">IT Department</option>
                                            <option value="security">Security Team</option>
                                            <option value="management">Management</option>
                                            <option value="legal">Legal & Compliance</option>
                                            <option value="communications">Communications</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="position" class="form-label">Position/Title</label>
                                        <input type="text" id="position" name="position" class="form-input" placeholder="e.g., Security Analyst">
                                    </div>

                                    <div class="form-group full-width">
                                        <label for="bio" class="form-label">Biography</label>
                                        <textarea id="bio" name="bio" class="form-textarea" rows="3" placeholder="Brief description about the user..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Profile Picture</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Upload Photo</label>
                                        <div class="avatar-upload">
                                            <div class="avatar-preview" id="avatarPreview">
                                                <div class="avatar-placeholder">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            </div>
                                            <div class="avatar-controls">
                                                <input type="file" id="avatar" name="avatar" accept="image/*" style="display: none;">
                                                <button type="button" class="btn btn-secondary" id="uploadBtn">
                                                    <i class="fas fa-camera"></i>
                                                    Choose Photo
                                                </button>
                                                <button type="button" class="btn btn-secondary" id="removeBtn" style="display: none;">
                                                    <i class="fas fa-trash"></i>
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Account Settings -->
                        <div class="form-step" id="step2" style="display: none;">
                            <div class="form-section">
                                <h3 class="section-title">Login Credentials</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="username" class="form-label required">Username</label>
                                        <input type="text" id="username" name="username" class="form-input" required>
                                        <small style="color: #6b7280; font-size: 0.75rem;">Username must be unique and contain only letters, numbers, and underscores</small>
                                        <span class="form-error" id="username-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="password" class="form-label required">Password</label>
                                        <div class="password-input">
                                            <input type="password" id="password" name="password" class="form-input" required>
                                            <button type="button" class="password-toggle" onclick="togglePassword('password')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <div class="password-strength" id="passwordStrength"></div>
                                        <span class="form-error" id="password-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label for="confirm_password" class="form-label required">Confirm Password</label>
                                        <div class="password-input">
                                            <input type="password" id="confirm_password" name="confirm_password" class="form-input" required>
                                            <button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                        <span class="form-error" id="confirm_password-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Password Options</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="require_password_change" value="1" checked>
                                                <span class="checkmark"></span>
                                                Require password change on first login
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="send_credentials" value="1" checked>
                                                <span class="checkmark"></span>
                                                Send login credentials via email
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <h3 class="section-title">Account Settings</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="status" class="form-label">Account Status</label>
                                        <select id="status" name="status" class="form-select">
                                            <option value="active" selected>Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="pending">Pending Activation</option>
                                            <option value="suspended">Suspended</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="timezone" class="form-label">Timezone</label>
                                        <select id="timezone" name="timezone" class="form-select">
                                            <option value="Asia/Jakarta" selected>WIB (UTC+7)</option>
                                            <option value="Asia/Makassar">WITA (UTC+8)</option>
                                            <option value="Asia/Jayapura">WIT (UTC+9)</option>
                                            <option value="UTC">UTC</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="language" class="form-label">Preferred Language</label>
                                        <select id="language" name="language" class="form-select">
                                            <option value="en" selected>English</option>
                                            <option value="id">Bahasa Indonesia</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Notification Preferences</label>
                                        <div class="checkbox-group">
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="notifications[]" value="email" checked>
                                                <span class="checkmark"></span>
                                                Email notifications
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="notifications[]" value="sms">
                                                <span class="checkmark"></span>
                                                SMS notifications
                                            </label>
                                            <label class="checkbox-label">
                                                <input type="checkbox" name="notifications[]" value="browser" checked>
                                                <span class="checkmark"></span>
                                                Browser notifications
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Permissions -->
                        <div class="form-step" id="step3" style="display: none;">
                            <div class="form-section">
                                <h3 class="section-title">Role & Permissions</h3>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="role" class="form-label required">User Role</label>
                                        <select id="role" name="role" class="form-select" required>
                                            <option value="">Select role</option>
                                            <option value="admin">Administrator</option>
                                            <option value="analyst">Security Analyst</option>
                                            <option value="responder">Incident Responder</option>
                                            <option value="viewer">Viewer</option>
                                        </select>
                                        <span class="form-error" id="role-error"></span>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Access Level</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="access_level" value="full">
                                                <span class="radio-mark"></span>
                                                Full Access
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="access_level" value="limited" checked>
                                                <span class="radio-mark"></span>
                                                Limited Access
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="access_level" value="restricted">
                                                <span class="radio-mark"></span>
                                                Restricted Access
                                            </label>
                                        </div>
                                    </div>

                                    <div class="form-group full-width">
                                        <label class="form-label">Module Permissions</label>
                                        <div class="permissions-grid">
                                            <div class="permission-module">
                                                <h4>Incident Management</h4>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="incidents.view" checked>
                                                        <span class="checkmark"></span>
                                                        View incidents
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="incidents.create">
                                                        <span class="checkmark"></span>
                                                        Create incidents
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="incidents.edit">
                                                        <span class="checkmark"></span>
                                                        Edit incidents
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="incidents.delete">
                                                        <span class="checkmark"></span>
                                                        Delete incidents
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="permission-module">
                                                <h4>News & Updates</h4>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="news.view" checked>
                                                        <span class="checkmark"></span>
                                                        View news
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="news.create">
                                                        <span class="checkmark"></span>
                                                        Create news
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="news.edit">
                                                        <span class="checkmark"></span>
                                                        Edit news
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="news.delete">
                                                        <span class="checkmark"></span>
                                                        Delete news
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="permission-module">
                                                <h4>User Management</h4>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="users.view">
                                                        <span class="checkmark"></span>
                                                        View users
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="users.create">
                                                        <span class="checkmark"></span>
                                                        Create users
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="users.edit">
                                                        <span class="checkmark"></span>
                                                        Edit users
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="users.delete">
                                                        <span class="checkmark"></span>
                                                        Delete users
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="permission-module">
                                                <h4>Reports & Analytics</h4>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="reports.view" checked>
                                                        <span class="checkmark"></span>
                                                        View reports
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="reports.create">
                                                        <span class="checkmark"></span>
                                                        Create reports
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="reports.export">
                                                        <span class="checkmark"></span>
                                                        Export reports
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="permission-module">
                                                <h4>System Settings</h4>
                                                <div class="checkbox-group">
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="settings.view">
                                                        <span class="checkmark"></span>
                                                        View settings
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="settings.edit">
                                                        <span class="checkmark"></span>
                                                        Edit settings
                                                    </label>
                                                    <label class="checkbox-label">
                                                        <input type="checkbox" name="permissions[]" value="logs.view">
                                                        <span class="checkmark"></span>
                                                        View security logs
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Navigation -->
                        <div class="form-navigation">
                            <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">
                                <i class="fas fa-arrow-left"></i>
                                Previous
                            </button>
                            <div class="nav-spacer"></div>
                            <button type="button" class="btn btn-secondary" onclick="history.back()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="nextBtn">
                                Next
                                <i class="fas fa-arrow-right"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">
                                <i class="fas fa-user-plus"></i>
                                Create User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 3;

        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');

        sidebarToggle.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        });

        // Multi-step form navigation
        document.getElementById('nextBtn').addEventListener('click', function() {
            if (validateStep(currentStep)) {
                nextStep();
            }
        });

        document.getElementById('prevBtn').addEventListener('click', function() {
            prevStep();
        });

        function nextStep() {
            if (currentStep < totalSteps) {
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
                
                currentStep++;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                
                updateNavigation();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).style.display = 'none';
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
                
                currentStep--;
                document.getElementById(`step${currentStep}`).style.display = 'block';
                document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
                document.querySelector(`[data-step="${currentStep}"]`).classList.remove('completed');
                
                updateNavigation();
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            
            // Show/hide previous button
            prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
            
            // Show/hide next/submit buttons
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'inline-flex';
            } else {
                nextBtn.style.display = 'inline-flex';
                submitBtn.style.display = 'none';
            }
        }

        // Avatar upload functionality
        document.getElementById('uploadBtn').addEventListener('click', function() {
            document.getElementById('avatar').click();
        });

        document.getElementById('avatar').addEventListener('change', function() {
            const file = this.files[0];
            const preview = document.getElementById('avatarPreview');
            const removeBtn = document.getElementById('removeBtn');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Avatar" class="avatar-img">`;
                    removeBtn.style.display = 'inline-flex';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('removeBtn').addEventListener('click', function() {
            document.getElementById('avatar').value = '';
            document.getElementById('avatarPreview').innerHTML = `
                <div class="avatar-placeholder">
                    <i class="fas fa-user"></i>
                </div>
            `;
            this.style.display = 'none';
        });

        // Auto-generate username from first and last name
        document.getElementById('first_name').addEventListener('input', generateUsername);
        document.getElementById('last_name').addEventListener('input', generateUsername);

        function generateUsername() {
            const firstName = document.getElementById('first_name').value.toLowerCase();
            const lastName = document.getElementById('last_name').value.toLowerCase();
            const usernameField = document.getElementById('username');
            
            if (firstName && lastName && !usernameField.value) {
                usernameField.value = firstName + '.' + lastName;
            }
        }

        // Password toggle functionality
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (field.type === 'password') {
                field.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                field.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password strength indicator
        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            const strengthIndicator = document.getElementById('passwordStrength');
            
            const strength = calculatePasswordStrength(password);
            strengthIndicator.innerHTML = `
                <div class="strength-bar">
                    <div class="strength-fill strength-${strength.level}" style="width: ${strength.percentage}%"></div>
                </div>
                <span class="strength-text">${strength.text}</span>
            `;
        });

        function calculatePasswordStrength(password) {
            let score = 0;
            
            if (password.length >= 8) score += 25;
            if (password.match(/[a-z]/)) score += 25;
            if (password.match(/[A-Z]/)) score += 25;
            if (password.match(/[0-9]/)) score += 25;
            if (password.match(/[^a-zA-Z0-9]/)) score += 25;
            
            let level = 'weak';
            let text = 'Weak';
            
            if (score >= 100) {
                level = 'very-strong';
                text = 'Very Strong';
            } else if (score >= 75) {
                level = 'strong';
                text = 'Strong';
            } else if (score >= 50) {
                level = 'medium';
                text = 'Medium';
            }
            
            return { level, text, percentage: Math.min(score, 100) };
        }

        // Form validation
        function validateStep(step) {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.form-error').forEach(error => error.textContent = '');
            document.querySelectorAll('.form-input, .form-select').forEach(field => {
                field.classList.remove('error');
            });
            
            if (step === 1) {
                const requiredFields = ['first_name', 'last_name', 'email'];
                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    const errorElement = document.getElementById(fieldName + '-error');
                    
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        errorElement.textContent = 'This field is required';
                        isValid = false;
                    }
                });
                
                // Email validation
                const email = document.getElementById('email');
                if (email.value && !isValidEmail(email.value)) {
                    email.classList.add('error');
                    document.getElementById('email-error').textContent = 'Please enter a valid email address';
                    isValid = false;
                }
            }
            
            if (step === 2) {
                const requiredFields = ['username', 'password', 'confirm_password'];
                requiredFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    const errorElement = document.getElementById(fieldName + '-error');
                    
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        errorElement.textContent = 'This field is required';
                        isValid = false;
                    }
                });
                
                // Password confirmation validation
                const password = document.getElementById('password');
                const confirmPassword = document.getElementById('confirm_password');
                
                if (password.value && confirmPassword.value && password.value !== confirmPassword.value) {
                    confirmPassword.classList.add('error');
                    document.getElementById('confirm_password-error').textContent = 'Passwords do not match';
                    isValid = false;
                }
                
                // Password strength validation
                if (password.value && password.value.length < 8) {
                    password.classList.add('error');
                    document.getElementById('password-error').textContent = 'Password must be at least 8 characters long';
                    isValid = false;
                }
            }
            
            if (step === 3) {
                const role = document.getElementById('role');
                if (!role.value) {
                    role.classList.add('error');
                    document.getElementById('role-error').textContent = 'Please select a role';
                    isValid = false;
                }
            }
            
            return isValid;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Form submission
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (validateStep(3)) {
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating User...';
                submitBtn.disabled = true;
                
                // Simulate API call
                setTimeout(() => {
                    alert('User created successfully!');
                    window.location.href = '/admin/users';
                }, 2000);
            }
        });

        // Role-based permission presets
        document.getElementById('role').addEventListener('change', function() {
            const role = this.value;
            const checkboxes = document.querySelectorAll('input[name="permissions[]"]');
            
            // Clear all permissions first
            checkboxes.forEach(cb => cb.checked = false);
            
            // Set permissions based on role
            switch (role) {
                case 'admin':
                    checkboxes.forEach(cb => cb.checked = true);
                    document.querySelector('input[value="full"]').checked = true;
                    break;
                case 'analyst':
                    ['incidents.view', 'incidents.create', 'incidents.edit', 'news.view', 'reports.view', 'reports.create'].forEach(perm => {
                        const cb = document.querySelector(`input[value="${perm}"]`);
                        if (cb) cb.checked = true;
                    });
                    document.querySelector('input[value="limited"]').checked = true;
                    break;
                case 'responder':
                    ['incidents.view', 'incidents.edit', 'news.view', 'reports.view'].forEach(perm => {
                        const cb = document.querySelector(`input[value="${perm}"]`);
                        if (cb) cb.checked = true;
                    });
                    document.querySelector('input[value="limited"]').checked = true;
                    break;
                case 'viewer':
                    ['incidents.view', 'news.view', 'reports.view'].forEach(perm => {
                        const cb = document.querySelector(`input[value="${perm}"]`);
                        if (cb) cb.checked = true;
                    });
                    document.querySelector('input[value="restricted"]').checked = true;
                    break;
            }
        });
    </script>
</body>

<!-- Logout form for CSRF protection -->
<form id="logout-form" action="/logout" method="POST" style="display: none;">
    <input type="hidden" name="_token" value="{{ csrf_token() }}">
</form>

</html>